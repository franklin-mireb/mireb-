<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Final Complet - Mireb CRM</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background-color: #f5f5f5; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        .header { background: linear-gradient(45deg, #2563eb, #7c3aed); color: white; padding: 30px; border-radius: 10px; margin-bottom: 30px; }
        .header h1 { font-size: 28px; margin-bottom: 10px; }
        .header p { opacity: 0.9; margin-bottom: 20px; }
        .status { display: flex; align-items: center; gap: 10px; font-size: 14px; }
        .status-dot { width: 12px; height: 12px; border-radius: 50%; background: #fbbf24; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .card { background: white; padding: 25px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .card h2 { font-size: 18px; margin-bottom: 20px; color: #1f2937; }
        .btn { padding: 12px 20px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; margin: 5px; display: inline-block; text-decoration: none; color: white; }
        .btn-blue { background: #2563eb; } .btn-blue:hover { background: #1d4ed8; }
        .btn-green { background: #16a34a; } .btn-green:hover { background: #15803d; }
        .btn-purple { background: #7c3aed; } .btn-purple:hover { background: #6d28d9; }
        .btn-orange { background: #ea580c; } .btn-orange:hover { background: #c2410c; }
        .btn-red { background: #dc2626; } .btn-red:hover { background: #b91c1c; }
        .upload-zone { border: 2px dashed #d1d5db; border-radius: 10px; padding: 40px; text-align: center; margin: 20px 0; }
        .upload-zone:hover { border-color: #2563eb; background: #f8fafc; }
        .result { padding: 15px; border-radius: 6px; margin: 10px 0; }
        .success { background: #dcfce7; color: #166534; }
        .error { background: #fee2e2; color: #991b1b; }
        .info { background: #dbeafe; color: #1e40af; }
        .warning { background: #fef3c7; color: #92400e; }
        .logs { background: #000; color: #00ff00; padding: 20px; border-radius: 10px; font-family: monospace; font-size: 12px; max-height: 300px; overflow-y: auto; white-space: pre-wrap; }
        .product-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; }
        .product-card { background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .product-image { width: 100%; height: 150px; object-fit: cover; }
        .product-info { padding: 15px; }
        .tag { padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; }
        .tag-cloudinary { background: #16a34a; color: white; }
        .tag-local { background: #ea580c; color: white; }
        input[type="file"] { display: none; }
        .platform-info { display: flex; justify-content: space-between; align-items: center; background: #f9fafb; padding: 12px; border-radius: 6px; margin: 8px 0; }
        #hostname { font-family: monospace; background: #e5e7eb; padding: 4px 8px; border-radius: 4px; }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üß™ Test Final Complet - Mireb CRM</h1>
            <p>Validation du fonctionnement des images Cloudinary et synchronisation des donn√©es</p>
            <div class="status">
                <div id="status-dot" class="status-dot"></div>
                <span id="status-text">Initialisation...</span>
                <span>|</span>
                <span id="platform-info">D√©tection plateforme...</span>
            </div>
        </div>

        <!-- Tests principaux -->
        <div class="grid">
            <!-- Diagnostic plateforme -->
            <div class="card">
                <h2>üñ•Ô∏è Diagnostic de Plateforme</h2>
                <div class="platform-info">
                    <span>Hostname:</span>
                    <code id="hostname">-</code>
                </div>
                <div class="platform-info">
                    <span>Est Render:</span>
                    <span id="is-render">-</span>
                </div>
                <div class="platform-info">
                    <span>Est GitHub Pages:</span>
                    <span id="is-github">-</span>
                </div>
                <div class="platform-info">
                    <span>Mode recommand√©:</span>
                    <strong id="recommended-mode">-</strong>
                </div>
            </div>

            <!-- Tests API -->
            <div class="card">
                <h2>üîå Test API Backend</h2>
                <button onclick="testAPI('/api/produits')" class="btn btn-blue">üì¶ Tester /api/produits</button><br>
                <button onclick="testAPI('/api/leads')" class="btn btn-green">üë• Tester /api/leads</button><br>
                <button onclick="testCloudinaryUpload()" class="btn btn-purple">‚òÅÔ∏è Tester Upload Cloudinary</button>
                <div id="api-results"></div>
            </div>
        </div>

        <!-- Upload test -->
        <div class="card">
            <h2>üì∑ Test Upload Image</h2>
            <div class="upload-zone" onclick="document.getElementById('test-file').click()">
                <div style="font-size: 48px; margin-bottom: 15px;">‚òÅÔ∏è</div>
                <p><strong>Cliquez pour s√©lectionner une image de test</strong></p>
                <p style="font-size: 12px; color: #666; margin-top: 8px;">PNG, JPG, GIF jusqu'√† 10MB</p>
            </div>
            <input type="file" id="test-file" accept="image/*" onchange="handleTestUpload(event)">
            <div id="upload-status"></div>
            <div id="upload-result"></div>
        </div>

        <!-- Produits existants -->
        <div class="card">
            <h2>üìã Produits Existants</h2>
            <button onclick="loadProducts()" class="btn btn-orange">üîÑ Charger les produits</button>
            <div id="products-list" class="product-grid"></div>
        </div>

        <!-- Actions rapides -->
        <div class="card">
            <h2>‚ö° Actions Rapides</h2>
            <button onclick="window.open('mireb-ai-crm-complete.html', '_blank')" class="btn btn-blue">üè† Ouvrir CRM Principal</button>
            <button onclick="window.open('https://mireb-5.onrender.com', '_blank')" class="btn btn-purple">üåê Ouvrir Render</button>
            <button onclick="testFullWorkflow()" class="btn btn-green">üîÑ Test Complet</button>
            <button onclick="clearAllData()" class="btn btn-red">üóëÔ∏è Nettoyer donn√©es</button>
        </div>

        <!-- Logs -->
        <div class="card">
            <h2>üìù Logs de Debug</h2>
            <button onclick="clearLogs()" class="btn btn-red" style="float: right;">Effacer</button>
            <div id="debug-logs" class="logs">En attente des tests...</div>
        </div>
    </div>

    <script>
        // Variables globales
        let debugLogs = [];
        const isRender = window.location.hostname.includes('onrender.com');
        const isGitHub = window.location.hostname.includes('github.io');
        const isLocal = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
        const API_BASE = isRender ? 'https://mireb-5.onrender.com' : '';

        // Fonction de logging am√©lior√©e
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const emoji = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
            const logEntry = `[${timestamp}] ${emoji} ${message}`;
            debugLogs.push(logEntry);
            
            if (debugLogs.length > 50) debugLogs.shift();
            
            document.getElementById('debug-logs').textContent = debugLogs.join('\n');
            console.log(logEntry);
        }

        function clearLogs() {
            debugLogs = [];
            document.getElementById('debug-logs').textContent = 'Logs effac√©s...';
        }

        // Initialisation
        function init() {
            log('üöÄ Initialisation du test final complet');
            
            // D√©tection de plateforme
            const hostname = window.location.hostname;
            document.getElementById('hostname').textContent = hostname;
            document.getElementById('is-render').textContent = isRender ? '‚úÖ Oui' : '‚ùå Non';
            document.getElementById('is-github').textContent = isGitHub ? '‚úÖ Oui' : '‚ùå Non';
            
            // Configuration par plateforme
            if (isRender) {
                document.getElementById('recommended-mode').innerHTML = '<span style="color: #16a34a;">API + Cloudinary</span>';
                document.getElementById('platform-info').textContent = 'üåê Render (Production)';
                document.getElementById('status-dot').style.background = '#16a34a';
                document.getElementById('status-text').textContent = 'Pr√™t pour tests production';
                log('Platform: Render - Mode production d√©tect√©');
            } else if (isGitHub) {
                document.getElementById('recommended-mode').innerHTML = '<span style="color: #2563eb;">LocalStorage + Fallback</span>';
                document.getElementById('platform-info').textContent = 'üì± GitHub Pages (D√©mo)';
                document.getElementById('status-dot').style.background = '#2563eb';
                document.getElementById('status-text').textContent = 'Mode d√©mo actif';
                log('Platform: GitHub Pages - Mode d√©mo d√©tect√©');
            } else {
                document.getElementById('recommended-mode').innerHTML = '<span style="color: #ea580c;">D√©veloppement local</span>';
                document.getElementById('platform-info').textContent = 'üíª Localhost';
                document.getElementById('status-dot').style.background = '#ea580c';
                document.getElementById('status-text').textContent = 'Environnement de d√©veloppement';
                log('Platform: Local - Mode d√©veloppement d√©tect√©');
            }
            
            log(`Configuration: Render=${isRender}, GitHub=${isGitHub}, Local=${isLocal}`);
        }

        // Test API
        async function testAPI(endpoint) {
            const fullUrl = API_BASE + endpoint;
            log(`üîó Test API: ${fullUrl}`);
            
            try {
                const response = await fetch(fullUrl);
                const data = await response.json();
                
                if (response.ok) {
                    log(`‚úÖ API ${endpoint} OK: ${Array.isArray(data) ? data.length + ' √©l√©ments' : 'R√©ponse valide'}`, 'success');
                    document.getElementById('api-results').innerHTML += `
                        <div class="result success">
                            <strong>‚úÖ ${endpoint}</strong><br>
                            Status: ${response.status}<br>
                            Data: ${Array.isArray(data) ? data.length + ' √©l√©ments' : 'Objet valide'}
                        </div>
                    `;
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                log(`‚ùå Erreur API ${endpoint}: ${error.message}`, 'error');
                document.getElementById('api-results').innerHTML += `
                    <div class="result error">
                        <strong>‚ùå ${endpoint}</strong><br>
                        Erreur: ${error.message}
                    </div>
                `;
            }
        }

        // Test upload Cloudinary automatique
        async function testCloudinaryUpload() {
            log('üß™ Cr√©ation et test d\'upload d\'image automatique');
            
            try {
                // Cr√©er une image de test
                const canvas = document.createElement('canvas');
                canvas.width = 300;
                canvas.height = 200;
                const ctx = canvas.getContext('2d');
                
                // Dessiner un fond d√©grad√©
                const gradient = ctx.createLinearGradient(0, 0, 300, 200);
                gradient.addColorStop(0, '#4F46E5');
                gradient.addColorStop(1, '#7C3AED');
                ctx.fillStyle = gradient;
                ctx.fillRect(0, 0, 300, 200);
                
                // Ajouter du texte
                ctx.fillStyle = 'white';
                ctx.font = 'bold 24px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('TEST MIREB', 150, 80);
                ctx.font = '16px Arial';
                ctx.fillText('Cloudinary Upload', 150, 110);
                ctx.fillText(new Date().toLocaleString(), 150, 140);
                
                // Convertir en blob et uploader
                canvas.toBlob(async (blob) => {
                    if (!isRender) {
                        log('‚ö†Ô∏è Test upload ignor√© - pas sur Render', 'warning');
                        document.getElementById('api-results').innerHTML += `
                            <div class="result warning">
                                <strong>‚ö†Ô∏è Upload Cloudinary</strong><br>
                                Ignor√©: Pas sur la plateforme Render
                            </div>
                        `;
                        return;
                    }
                    
                    const formData = new FormData();
                    formData.append('image', blob, 'test-mireb.png');
                    
                    try {
                        const response = await fetch(API_BASE + '/api/upload/single', {
                            method: 'POST',
                            body: formData
                        });
                        
                        const result = await response.json();
                        
                        if (response.ok && result.success) {
                            log(`‚úÖ Upload Cloudinary r√©ussi: ${result.data.url}`, 'success');
                            document.getElementById('api-results').innerHTML += `
                                <div class="result success">
                                    <strong>‚úÖ Upload Cloudinary</strong><br>
                                    URL: <a href="${result.data.url}" target="_blank" style="color: #2563eb; text-decoration: underline;">Voir image</a>
                                </div>
                            `;
                        } else {
                            throw new Error(result.message || 'Upload √©chou√©');
                        }
                    } catch (error) {
                        log(`‚ùå Erreur upload: ${error.message}`, 'error');
                        document.getElementById('api-results').innerHTML += `
                            <div class="result error">
                                <strong>‚ùå Upload Cloudinary</strong><br>
                                Erreur: ${error.message}
                            </div>
                        `;
                    }
                }, 'image/png');
                
            } catch (error) {
                log(`‚ùå Erreur cr√©ation image test: ${error.message}`, 'error');
            }
        }

        // Upload fichier utilisateur
        async function handleTestUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            log(`üìÅ Upload fichier: ${file.name} (${(file.size/1024/1024).toFixed(2)}MB)`);
            
            document.getElementById('upload-status').innerHTML = `
                <div class="result info">
                    üîÑ Upload en cours: ${file.name}...
                </div>
            `;
            
            try {
                if (isRender) {
                    // Upload vers Cloudinary
                    const formData = new FormData();
                    formData.append('image', file);
                    
                    const response = await fetch(API_BASE + '/api/upload/single', {
                        method: 'POST',
                        body: formData
                    });
                    
                    const result = await response.json();
                    
                    if (response.ok && result.success) {
                        log(`‚úÖ Upload Cloudinary r√©ussi: ${result.data.url}`, 'success');
                        showUploadResult(result.data.url, 'Cloudinary ‚òÅÔ∏è', true);
                    } else {
                        throw new Error(result.message || 'Upload API √©chou√©');
                    }
                } else {
                    // Fallback local
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        log(`üì± Sauvegarde locale r√©ussie (mode d√©mo)`, 'success');
                        showUploadResult(e.target.result, 'Local (D√©mo) üì±', false);
                    };
                    reader.readAsDataURL(file);
                }
            } catch (error) {
                log(`‚ùå Erreur upload: ${error.message}`, 'error');
                document.getElementById('upload-status').innerHTML = `
                    <div class="result error">
                        ‚ùå Erreur: ${error.message}
                    </div>
                `;
            }
        }

        function showUploadResult(imageUrl, mode, isCloudinary) {
            document.getElementById('upload-status').innerHTML = `
                <div class="result success">
                    ‚úÖ Upload r√©ussi vers ${mode}
                </div>
            `;
            
            document.getElementById('upload-result').innerHTML = `
                <div style="border: 1px solid #e5e7eb; border-radius: 8px; padding: 15px; margin-top: 15px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <strong>R√©sultat de l'upload</strong>
                        <span class="tag ${isCloudinary ? 'tag-cloudinary' : 'tag-local'}">${mode}</span>
                    </div>
                    <img src="${imageUrl}" alt="Image upload√©e" style="max-width: 100%; max-height: 200px; border-radius: 6px; margin-bottom: 10px;">
                    <p style="font-size: 12px; color: #666; word-break: break-all;"><strong>URL:</strong> ${imageUrl}</p>
                    <p style="font-size: 12px; margin-top: 8px; ${isCloudinary ? 'color: #16a34a;' : 'color: #2563eb;'}">
                        ${isCloudinary ? '‚úÖ Cette image sera visible sur tous les appareils' : 'üì± Cette image n\'est visible que localement (mode d√©mo)'}
                    </p>
                </div>
            `;
        }

        // Charger produits
        async function loadProducts() {
            log('üì¶ Chargement des produits...');
            
            try {
                let products;
                let source;
                
                if (isRender) {
                    const response = await fetch(API_BASE + '/api/produits');
                    products = await response.json();
                    source = 'API Backend';
                } else {
                    products = JSON.parse(localStorage.getItem('mireb_produits') || '[]');
                    source = 'LocalStorage';
                }
                
                displayProducts(products, source);
            } catch (error) {
                log(`‚ùå Erreur chargement produits: ${error.message}`, 'error');
                document.getElementById('products-list').innerHTML = `
                    <div class="result error">
                        ‚ùå Erreur lors du chargement: ${error.message}
                    </div>
                `;
            }
        }

        function displayProducts(products, source) {
            const container = document.getElementById('products-list');
            
            if (!products || products.length === 0) {
                container.innerHTML = `
                    <div class="result warning">
                        üì¶ Aucun produit trouv√©<br>
                        <small>Source: ${source}</small>
                    </div>
                `;
                log(`üì¶ Aucun produit trouv√© (source: ${source})`, 'warning');
                return;
            }
            
            log(`üì¶ ${products.length} produit(s) charg√©(s) depuis ${source}`, 'success');
            
            container.innerHTML = products.map(product => {
                const imageUrl = Array.isArray(product.images) ? product.images[0] : 
                               (product.image || 'https://via.placeholder.com/300x200?text=Produit');
                const isCloudinaryImage = imageUrl.includes('cloudinary.com') || imageUrl.includes('res.cloudinary.com');
                
                return `
                    <div class="product-card">
                        <img src="${imageUrl}" alt="${product.nom || 'Produit'}" class="product-image" 
                             onerror="this.src='https://via.placeholder.com/300x200?text=Erreur+Image'">
                        <div class="product-info">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                                <h3 style="font-weight: bold; font-size: 16px;">${product.nom || 'Sans nom'}</h3>
                                <span class="tag ${isCloudinaryImage ? 'tag-cloudinary' : 'tag-local'}">
                                    ${isCloudinaryImage ? 'Cloudinary' : 'Local'}
                                </span>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <span style="font-size: 18px; font-weight: bold; color: #16a34a;">$${product.prix || '0'}</span>
                                <span style="font-size: 12px; color: #666;">Stock: ${product.stock || '0'}</span>
                            </div>
                            <p style="font-size: 12px; color: #666; margin-bottom: 8px;">${product.categorie || 'Non cat√©goris√©'}</p>
                            <div style="font-size: 11px; color: #999;">
                                <p><strong>ID:</strong> ${product.id}</p>
                                <p><strong>Images:</strong> ${Array.isArray(product.images) ? product.images.length : '1'}</p>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Test workflow complet
        async function testFullWorkflow() {
            log('üîÑ D√©but du test workflow complet');
            
            // Nettoyer les r√©sultats pr√©c√©dents
            document.getElementById('api-results').innerHTML = '';
            
            // Test 1: API Produits
            log('1Ô∏è‚É£ Test des produits...');
            await testAPI('/api/produits');
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            // Test 2: API Leads
            log('2Ô∏è‚É£ Test des leads...');
            await testAPI('/api/leads');
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            // Test 3: Upload si sur Render
            if (isRender) {
                log('3Ô∏è‚É£ Test upload automatique...');
                await testCloudinaryUpload();
                await new Promise(resolve => setTimeout(resolve, 1000));
            }
            
            // Test 4: Chargement produits
            log('4Ô∏è‚É£ Chargement des produits...');
            await loadProducts();
            
            log('‚úÖ Test workflow complet termin√©!', 'success');
        }

        // Nettoyer donn√©es
        function clearAllData() {
            if (confirm('‚ö†Ô∏è √ätes-vous s√ªr de vouloir nettoyer toutes les donn√©es locales ?')) {
                localStorage.clear();
                document.getElementById('products-list').innerHTML = '';
                document.getElementById('api-results').innerHTML = '';
                document.getElementById('upload-result').innerHTML = '';
                document.getElementById('upload-status').innerHTML = '';
                log('üóëÔ∏è Toutes les donn√©es locales ont √©t√© effac√©es', 'warning');
            }
        }

        // Initialiser au chargement
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
