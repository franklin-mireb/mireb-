<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Final - Mireb CRM</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-gradient-to-br from-blue-50 to-green-50 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <div class="max-w-4xl mx-auto">
            <!-- Header -->
            <div class="text-center mb-8">
                <h1 class="text-4xl font-bold text-gray-800 mb-4">
                    üéØ Mireb CRM - Test Final
                </h1>
                <p class="text-gray-600">Serveur unifi√© sans probl√®me CORS</p>
            </div>

            <!-- Status -->
            <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                <div class="flex items-center justify-between">
                    <div>
                        <h2 class="text-xl font-semibold">Status Syst√®me</h2>
                        <p class="text-gray-600">V√©rification automatique</p>
                    </div>
                    <div id="systemStatus" class="text-2xl">
                        <i class="fas fa-spinner fa-spin text-yellow-500"></i>
                    </div>
                </div>
                <div class="mt-4 grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                    <div class="bg-gray-50 p-3 rounded">
                        <div class="font-medium">Frontend</div>
                        <div id="frontendStatus" class="text-gray-600">V√©rification...</div>
                    </div>
                    <div class="bg-gray-50 p-3 rounded">
                        <div class="font-medium">API Backend</div>
                        <div id="apiStatus" class="text-gray-600">V√©rification...</div>
                    </div>
                    <div class="bg-gray-50 p-3 rounded">
                        <div class="font-medium">Base de donn√©es</div>
                        <div id="dbStatus" class="text-gray-600">En m√©moire ‚úÖ</div>
                    </div>
                </div>
            </div>

            <!-- Tests Rapides -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                <button onclick="testAPI()" class="bg-blue-500 text-white p-4 rounded-lg hover:bg-blue-600 transition-colors">
                    <i class="fas fa-heartbeat text-2xl mb-2"></i>
                    <div class="font-semibold">Test API</div>
                </button>
                
                <button onclick="testCreateProduct()" class="bg-green-500 text-white p-4 rounded-lg hover:bg-green-600 transition-colors">
                    <i class="fas fa-plus text-2xl mb-2"></i>
                    <div class="font-semibold">Cr√©er Produit</div>
                </button>
                
                <button onclick="testUpload()" class="bg-purple-500 text-white p-4 rounded-lg hover:bg-purple-600 transition-colors">
                    <i class="fas fa-cloud-upload-alt text-2xl mb-2"></i>
                    <div class="font-semibold">Test Upload</div>
                </button>
                
                <button onclick="testAI()" class="bg-orange-500 text-white p-4 rounded-lg hover:bg-orange-600 transition-colors">
                    <i class="fas fa-robot text-2xl mb-2"></i>
                    <div class="font-semibold">Test IA</div>
                </button>
            </div>

            <!-- Formulaire de Test -->
            <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                <h2 class="text-xl font-semibold mb-4">
                    <i class="fas fa-shopping-cart text-green-500 mr-2"></i>
                    Test Cr√©ation Produit Complet
                </h2>
                
                <form id="testForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">Nom du produit</label>
                        <input type="text" id="productName" value="Produit Test Final" 
                               class="w-full px-3 py-2 border rounded-md focus:ring-2 focus:ring-green-500">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium mb-2">Cat√©gorie</label>
                        <select id="productCategory" class="w-full px-3 py-2 border rounded-md focus:ring-2 focus:ring-green-500">
                            <option value="√âlectronique">√âlectronique</option>
                            <option value="Mode">Mode</option>
                            <option value="Automobile">Automobile</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium mb-2">Prix ($)</label>
                        <input type="number" id="productPrice" value="149.99" step="0.01"
                               class="w-full px-3 py-2 border rounded-md focus:ring-2 focus:ring-green-500">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium mb-2">Stock</label>
                        <input type="number" id="productStock" value="25"
                               class="w-full px-3 py-2 border rounded-md focus:ring-2 focus:ring-green-500">
                    </div>
                    
                    <div class="md:col-span-2">
                        <button type="submit" class="w-full bg-green-500 text-white py-3 px-6 rounded-lg hover:bg-green-600 font-semibold">
                            <i class="fas fa-rocket mr-2"></i>
                            CR√âER LE PRODUIT (TEST FINAL)
                        </button>
                    </div>
                </form>
            </div>

            <!-- Actions -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <a href="admin-add-product.html" 
                   class="block bg-indigo-500 text-white text-center py-4 px-6 rounded-lg hover:bg-indigo-600 transition-colors">
                    <i class="fas fa-tools text-xl mb-2"></i>
                    <div class="font-semibold">Interface Compl√®te</div>
                    <div class="text-sm opacity-90">admin-add-product.html</div>
                </a>
                
                <button onclick="runAllTests()" 
                        class="bg-yellow-500 text-white py-4 px-6 rounded-lg hover:bg-yellow-600 transition-colors">
                    <i class="fas fa-play-circle text-xl mb-2"></i>
                    <div class="font-semibold">Lancer Tous les Tests</div>
                    <div class="text-sm opacity-90">V√©rification compl√®te</div>
                </button>
            </div>

            <!-- R√©sultats -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-semibold">
                        <i class="fas fa-terminal text-gray-600 mr-2"></i>
                        Console de Test
                    </h2>
                    <button onclick="clearResults()" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">
                        <i class="fas fa-trash mr-1"></i>Effacer
                    </button>
                </div>
                <div id="results" class="bg-gray-900 text-green-400 font-mono text-sm p-4 rounded-lg h-64 overflow-y-auto">
                    <div>üöÄ Console Mireb CRM initialis√©e...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '/api'; // M√™me port, pas de CORS

        function log(message, type = 'info') {
            const results = document.getElementById('results');
            const timestamp = new Date().toLocaleTimeString();
            
            const colors = {
                success: 'text-green-400',
                error: 'text-red-400',
                warning: 'text-yellow-400',
                info: 'text-blue-400'
            };
            
            const div = document.createElement('div');
            div.className = colors[type] || colors.info;
            div.textContent = `[${timestamp}] ${message}`;
            
            results.appendChild(div);
            results.scrollTop = results.scrollHeight;
        }

        function clearResults() {
            const results = document.getElementById('results');
            results.innerHTML = '<div>üöÄ Console Mireb CRM r√©initialis√©e...</div>';
        }

        async function makeRequest(url, options = {}) {
            try {
                log(`üîÑ Requ√™te vers: ${url}`);
                const response = await fetch(url, {
                    headers: { 'Content-Type': 'application/json', ...options.headers },
                    ...options
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    log(`‚úÖ Succ√®s: ${response.status}`, 'success');
                    return { success: true, data, status: response.status };
                } else {
                    log(`‚ùå Erreur: ${response.status} - ${data.message}`, 'error');
                    return { success: false, data, status: response.status };
                }
            } catch (error) {
                log(`üí• Erreur r√©seau: ${error.message}`, 'error');
                return { success: false, error: error.message };
            }
        }

        async function testAPI() {
            const result = await makeRequest(`${API_BASE}/health`);
            
            if (result.success) {
                document.getElementById('apiStatus').innerHTML = '‚úÖ Fonctionnel';
                document.getElementById('systemStatus').innerHTML = '<i class="fas fa-check-circle text-green-500"></i>';
                log(`API Health: ${result.data.message}`, 'success');
            } else {
                document.getElementById('apiStatus').innerHTML = '‚ùå Erreur';
                document.getElementById('systemStatus').innerHTML = '<i class="fas fa-times-circle text-red-500"></i>';
            }
        }

        async function testCreateProduct() {
            const testProduct = {
                nom: "Produit Test Rapide",
                description: "Test de cr√©ation rapide",
                prix: 99.99,
                categorie: "Test",
                stock: 10,
                ville: "Kinshasa"
            };

            const result = await makeRequest(`${API_BASE}/produits`, {
                method: 'POST',
                body: JSON.stringify(testProduct)
            });

            if (result.success) {
                log(`üéâ Produit cr√©√©: ID ${result.data.data.id}`, 'success');
            }
        }

        async function testUpload() {
            const result = await makeRequest(`${API_BASE}/upload/single`, {
                method: 'POST',
                body: JSON.stringify({})
            });

            if (result.success) {
                log(`üì§ Upload simul√© r√©ussi`, 'success');
            }
        }

        async function testAI() {
            const result = await makeRequest(`${API_BASE}/openai/generate-description`, {
                method: 'POST',
                body: JSON.stringify({
                    nom: "Test IA",
                    categorie: "√âlectronique"
                })
            });

            if (result.success) {
                log(`ü§ñ IA Description g√©n√©r√©e`, 'success');
            }
        }

        async function runAllTests() {
            log('üöÄ === D√âBUT TESTS COMPLETS ===', 'warning');
            await testAPI();
            await new Promise(resolve => setTimeout(resolve, 500));
            await testCreateProduct();
            await new Promise(resolve => setTimeout(resolve, 500));
            await testUpload();
            await new Promise(resolve => setTimeout(resolve, 500));
            await testAI();
            log('‚úÖ === TESTS TERMIN√âS ===', 'warning');
        }

        // Gestionnaire de formulaire
        document.getElementById('testForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const productData = {
                nom: document.getElementById('productName').value,
                categorie: document.getElementById('productCategory').value,
                prix: parseFloat(document.getElementById('productPrice').value),
                stock: parseInt(document.getElementById('productStock').value),
                description: `Description automatique pour ${document.getElementById('productName').value}`,
                ville: "Kinshasa",
                stockMinimum: 5,
                adresse: "Test Avenue",
                tags: ["test", "final"],
                caracteristiques: [],
                createdAt: new Date().toISOString(),
                createdBy: "Test User"
            };

            log('üî• === CR√âATION PRODUIT COMPL√àTE ===', 'warning');
            log(`üìã Donn√©es: ${JSON.stringify(productData, null, 2)}`);

            const result = await makeRequest(`${API_BASE}/produits`, {
                method: 'POST',
                body: JSON.stringify(productData)
            });

            if (result.success) {
                log(`üéØ SUCC√àS TOTAL! Produit cr√©√© avec ID: ${result.data.data.id}`, 'success');
                log(`üìù Nom: ${result.data.data.nom}`, 'success');
                log(`üí∞ Prix: $${result.data.data.prix}`, 'success');
                log(`üì¶ Stock: ${result.data.data.stock} unit√©s`, 'success');
            }
        });

        // Initialisation
        window.addEventListener('load', () => {
            log('üåü Interface de test final charg√©e');
            log(`üîó API configur√©e: ${API_BASE}`);
            
            document.getElementById('frontendStatus').innerHTML = '‚úÖ Charg√©';
            
            // Test automatique
            setTimeout(testAPI, 1000);
        });
    </script>
</body>
</html>
