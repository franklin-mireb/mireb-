<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Rapide - Mireb CRM</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-2xl mx-auto">
        <div class="bg-white rounded-lg shadow-lg p-6">
            <h1 class="text-2xl font-bold mb-6 text-center">🧪 Test Rapide Mireb CRM</h1>
            
            <!-- Status -->
            <div id="status" class="mb-6 p-4 rounded-lg bg-blue-50 border border-blue-200">
                <div class="flex items-center justify-between">
                    <span>Status Backend:</span>
                    <span id="statusText" class="font-semibold">Vérification...</span>
                </div>
                <div class="text-sm text-gray-600 mt-1">
                    API: <span id="apiUrl" class="font-mono">http://localhost:5001/api</span>
                </div>
            </div>

            <!-- Tests -->
            <div class="space-y-4">
                <button onclick="testHealth()" class="w-full bg-blue-500 text-white py-3 px-4 rounded-lg hover:bg-blue-600">
                    1. Test Connexion Backend
                </button>
                
                <button onclick="testCreateProduct()" class="w-full bg-green-500 text-white py-3 px-4 rounded-lg hover:bg-green-600">
                    2. Test Création Produit
                </button>
                
                <button onclick="testUpload()" class="w-full bg-purple-500 text-white py-3 px-4 rounded-lg hover:bg-purple-600">
                    3. Test Upload Image
                </button>
                
                <button onclick="testAI()" class="w-full bg-orange-500 text-white py-3 px-4 rounded-lg hover:bg-orange-600">
                    4. Test IA Description
                </button>
            </div>

            <!-- Résultats -->
            <div id="results" class="mt-6 p-4 bg-gray-50 rounded-lg">
                <h3 class="font-semibold mb-2">Résultats des tests:</h3>
                <div id="resultsList" class="space-y-2 text-sm"></div>
            </div>

            <!-- Actions -->
            <div class="mt-6 space-y-2">
                <a href="admin-add-product.html" class="block w-full bg-indigo-500 text-white py-3 px-4 rounded-lg hover:bg-indigo-600 text-center">
                    🚀 Ouvrir Interface Ajout Produit
                </a>
                <button onclick="runAllTests()" class="w-full bg-gray-500 text-white py-2 px-4 rounded-lg hover:bg-gray-600">
                    Lancer tous les tests
                </button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:5001/api';
        document.getElementById('apiUrl').textContent = API_BASE;

        function addResult(test, success, message) {
            const resultsList = document.getElementById('resultsList');
            const div = document.createElement('div');
            div.className = `p-2 rounded ${success ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`;
            div.innerHTML = `
                <span class="font-medium">${test}:</span>
                ${success ? '✅' : '❌'} ${message}
            `;
            resultsList.appendChild(div);
        }

        async function makeRequest(url, options = {}) {
            try {
                const response = await fetch(url, {
                    headers: { 'Content-Type': 'application/json', ...options.headers },
                    ...options
                });
                const data = await response.json();
                return { success: response.ok, data, status: response.status };
            } catch (error) {
                return { success: false, error: error.message };
            }
        }

        async function testHealth() {
            const result = await makeRequest(`${API_BASE}/health`);
            if (result.success) {
                addResult('Connexion Backend', true, `Status: ${result.data.status}`);
                document.getElementById('statusText').textContent = '🟢 Connecté';
                document.getElementById('status').className = 'mb-6 p-4 rounded-lg bg-green-50 border border-green-200';
            } else {
                addResult('Connexion Backend', false, result.error || 'Erreur de connexion');
                document.getElementById('statusText').textContent = '🔴 Déconnecté';
                document.getElementById('status').className = 'mb-6 p-4 rounded-lg bg-red-50 border border-red-200';
            }
        }

        async function testCreateProduct() {
            const testProduct = {
                nom: "Produit Test " + Date.now(),
                description: "Description du produit de test",
                prix: 99.99,
                categorie: "Électronique",
                stock: 5,
                ville: "Kinshasa"
            };

            const result = await makeRequest(`${API_BASE}/produits`, {
                method: 'POST',
                body: JSON.stringify(testProduct)
            });

            if (result.success) {
                addResult('Création Produit', true, `Produit créé avec ID: ${result.data.data.id}`);
            } else {
                addResult('Création Produit', false, result.data?.message || result.error);
            }
        }

        async function testUpload() {
            const result = await makeRequest(`${API_BASE}/upload/single`, {
                method: 'POST',
                body: JSON.stringify({})
            });

            if (result.success) {
                addResult('Upload Image', true, 'Image simulée uploadée');
            } else {
                addResult('Upload Image', false, result.data?.message || result.error);
            }
        }

        async function testAI() {
            const result = await makeRequest(`${API_BASE}/openai/generate-description`, {
                method: 'POST',
                body: JSON.stringify({
                    nom: "Smartphone Test",
                    categorie: "Électronique"
                })
            });

            if (result.success) {
                addResult('IA Description', true, 'Description générée avec succès');
            } else {
                addResult('IA Description', false, result.data?.message || result.error);
            }
        }

        async function runAllTests() {
            document.getElementById('resultsList').innerHTML = '';
            await testHealth();
            await new Promise(resolve => setTimeout(resolve, 500));
            await testCreateProduct();
            await new Promise(resolve => setTimeout(resolve, 500));
            await testUpload();
            await new Promise(resolve => setTimeout(resolve, 500));
            await testAI();
        }

        // Test automatique au chargement
        testHealth();
    </script>
</body>
</html>
